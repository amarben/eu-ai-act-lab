import { test, expect } from '@playwright/test';
import { prisma } from '@/lib/prisma';
import { hash } from 'bcryptjs';
import { login } from './helpers/auth';

/**
 * Organization & Profile Setup Module - E2E Tests
 *
 * Tests cover:
 * - Settings page navigation and tabs
 * - Organization profile viewing and editing (admin only)
 * - Logo upload and deletion (admin only)
 * - Team management: invite, update role, remove users (admin only)
 * - User settings and account information
 * - Authorization checks for admin-only features
 */

test.describe('Organization & Profile Setup', () => {
  let testOrgId: string;
  let adminUserId: string;
  let regularUserId: string;
  let adminEmail: string;
  let regularUserEmail: string;

  test.beforeAll(async () => {
    // Create test organization
    const org = await prisma.organization.create({
      data: {
        name: 'Test Organization for Settings',
        legalName: 'Test Org Legal Name',
        industry: 'TECHNOLOGY',
        size: 'MEDIUM',
        euPresence: true,
        headquarters: 'Brussels, Belgium',
        region: 'European Union',
        registrationNumber: 'BE123456789',
        description: 'A test organization for settings module testing',
      },
    });
    testOrgId = org.id;

    // Create admin user
    adminEmail = `admin-settings-${Date.now()}@test.com`;
    const adminPassword = await hash('admin123', 10);
    const admin = await prisma.user.create({
      data: {
        email: adminEmail,
        name: 'Settings Admin',
        passwordHash: adminPassword,
        role: 'ADMIN',
        organizationId: testOrgId,
        emailVerified: new Date(),
      },
    });
    adminUserId = admin.id;

    // Create regular user
    regularUserEmail = `user-settings-${Date.now()}@test.com`;
    const userPassword = await hash('user123', 10);
    const user = await prisma.user.create({
      data: {
        email: regularUserEmail,
        name: 'Settings User',
        passwordHash: userPassword,
        role: 'USER',
        organizationId: testOrgId,
        emailVerified: new Date(),
      },
    });
    regularUserId = user.id;
  });

  test.afterAll(async () => {
    // Clean up test data
    await prisma.user.deleteMany({
      where: { organizationId: testOrgId },
    });
    await prisma.organization.delete({
      where: { id: testOrgId },
    });
  });

  test.describe('Settings Page Navigation', () => {
    test('should navigate to settings page from sidebar', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });

      // Click settings in sidebar
      await page.click('[data-testid="nav-settings"]');

      // Verify on settings page
      await expect(page).toHaveURL('/dashboard/settings');
      await expect(page.locator('h1')).toContainText('Settings');
    });

    test('should display all three tabs', async ({ page }) => {
      // Login and navigate to settings
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      // Check all tabs exist
      await expect(page.locator('button[role="tab"]', { hasText: 'Organization Profile' })).toBeVisible();
      await expect(page.locator('button[role="tab"]', { hasText: 'Team Management' })).toBeVisible();
      await expect(page.locator('button[role="tab"]', { hasText: 'My Account' })).toBeVisible();
    });

    test('should switch between tabs', async ({ page }) => {
      // Login and navigate to settings
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      // Click Team Management tab and wait for content
      await page.click('button[role="tab"]:has-text("Team Management")');
      await page.waitForTimeout(500);
      await expect(page.locator('text=Team Members')).toBeVisible();

      // Click My Account tab and wait for content
      await page.click('button[role="tab"]:has-text("My Account")');
      await page.waitForTimeout(500);
      await expect(page.locator('text=Personal Information')).toBeVisible();

      // Click Organization Profile tab and wait for content
      await page.click('button[role="tab"]:has-text("Organization Profile")');
      await page.waitForTimeout(500);
      await expect(page.locator('text=Organization Information')).toBeVisible();
    });
  });

  test.describe('Organization Profile - View Mode', () => {
    test('should display organization information correctly', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      //  organization details are displayed
      await expect(page.locator('text=Test Organization for Settings')).toBeVisible();
      await expect(page.locator('text=Test Org Legal Name')).toBeVisible();
      await expect(page.locator('text=Technology')).toBeVisible();
      await expect(page.locator('text=Medium (51-250 employees)')).toBeVisible();
      await expect(page.locator('text=Brussels, Belgium')).toBeVisible();
      await expect(page.locator('text=European Union')).toBeVisible();
      await expect(page.locator('text=BE123456789')).toBeVisible();
      await expect(page.locator('text=A test organization for settings module testing')).toBeVisible();
    });

    test('should display organization statistics', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');

      // Check statistics section
      await expect(page.locator('text=Organization Statistics')).toBeVisible();
      await expect(page.locator('text=Team Members')).toBeVisible();
      await expect(page.locator('text=AI Systems')).toBeVisible();
    });

    test('should show Edit Profile button for admins', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');

      // Check for Edit Profile button
      await expect(page.locator('button:has-text("Edit Profile")')).toBeVisible();
    });

    test('should NOT show Edit Profile button for regular users', async ({ page }) => {
      // Login as regular user
      await login(page, { email: regularUserEmail, password: 'user123' });
      await page.goto('/dashboard/settings');

      // Edit Profile button should not exist
      await expect(page.locator('button:has-text("Edit Profile")')).not.toBeVisible();
    });
  });

  test.describe('Organization Profile - Edit Mode (Admin Only)', () => {
    test('should enter edit mode when clicking Edit Profile', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      //  Edit Profile
      await page.click('button:has-text("Edit Profile")');

      // Check that form inputs are now visible
      await expect(page.locator('input[id="name"]')).toBeVisible();
      await expect(page.locator('input[id="legalName"]')).toBeVisible();
      await expect(page.locator('button:has-text("Save Changes")')).toBeVisible();
      await expect(page.locator('button:has-text("Cancel")')).toBeVisible();
    });

    test('should update organization name successfully', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');

      // Enter edit mode
      await page.click('button:has-text("Edit Profile")');

      // Update organization name
      const newName = `Updated Test Org ${Date.now()}`;
      await page.fill('input[id="name"]', newName);

      // Save changes
      await page.click('button:has-text("Save Changes")');

      // Wait for success toast
      await expect(page.locator('text=Organization profile updated')).toBeVisible();

      // Verify name was updated
      await expect(page.locator(`text=${newName}`)).toBeVisible();
    });

    test('should update multiple fields at once', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');

      // Enter edit mode
      await page.click('button:has-text("Edit Profile")');

      // Update multiple fields
      await page.fill('input[id="headquarters"]', 'Paris, France');
      await page.fill('input[id="region"]', 'France');
      await page.fill('input[id="registrationNumber"]', 'FR987654321');

      // Save changes
      await page.click('button:has-text("Save Changes")');

      // Wait for success
      await expect(page.locator('text=Organization profile updated')).toBeVisible();

      // Verify updates
      await expect(page.locator('text=Paris, France')).toBeVisible();
      await expect(page.locator('text=FR987654321')).toBeVisible();
    });

    test('should cancel editing without saving changes', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');

      // Get current name
      const currentNameElement = page.locator('input[id="name"]').or(page.locator('text=Test Organization'));

      // Enter edit mode
      await page.click('button:has-text("Edit Profile")');

      // Change name
      await page.fill('input[id="name"]', 'This Should Not Save');

      // Click Cancel
      await page.click('button:has-text("Cancel")');

      // Verify name did not change
      await expect(page.locator('text=This Should Not Save')).not.toBeVisible();
      await expect(page.locator('button:has-text("Edit Profile")')).toBeVisible();
    });

    test('should update industry selection', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');

      // Enter edit mode
      await page.click('button:has-text("Edit Profile")');

      // Change industry
      await page.click('button[id="industry"]');
      await page.click('text=Healthcare');

      // Save changes
      await page.click('button:has-text("Save Changes")');

      // Wait for success
      await expect(page.locator('text=Organization profile updated')).toBeVisible();

      // Verify industry updated
      await expect(page.locator('text=Healthcare')).toBeVisible();
    });

    test('should update organization size', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');

      // Enter edit mode
      await page.click('button:has-text("Edit Profile")');

      // Change size
      await page.click('button[id="size"]');
      await page.click('text=Large (251-1000 employees)');

      // Save changes
      await page.click('button:has-text("Save Changes")');

      // Wait for success
      await expect(page.locator('text=Organization profile updated')).toBeVisible();

      // Verify size updated
      await expect(page.locator('text=Large (251-1000 employees)')).toBeVisible();
    });

    test('should toggle EU presence', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');

      // Enter edit mode
      await page.click('button:has-text("Edit Profile")');

      // Toggle EU presence
      await page.click('input[id="euPresence"]');

      // Save changes
      await page.click('button:has-text("Save Changes")');

      // Wait for success
      await expect(page.locator('text=Organization profile updated')).toBeVisible();
    });
  });

  test.describe('await page.click('button[role="tab"]:has-text("Team Management")');
      await page.waitForTimeout(300);

      // Verify table headers
      await expect(page.locator('text=User')).toBeVisible();
      await expect(page.locator('text=Email')).toBeVisible();
      await expect(page.locator('text=Role')).toBeVisible();
      await expect(page.locator('text=Status')).toBeVisible();

      // Verify both users are listed
      await expect(page.locator(`text=${adminEmail}`)).toBeVisible();
      await expect(page.locator(`text=${regularUserEmail}`)).toBeVisible();
    });

    test('should display team statistics', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      //  to await page.click('button[role="tab"]:has-text("Team Management")');
      await page.waitForTimeout(300);

      // Check statistics
      await expect(page.locator('text=Team Statistics')).toBeVisible();
      await expect(page.locator('text=Total Members')).toBeVisible();
      await expect(page.locator('text=Administrators')).toBeVisible();
      await expect(page.locator('text=Active Users')).toBeVisible();
    });

    test('should show "You" badge for current user', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      //  to await page.click('button[role="tab"]:has-text("Team Management")');
      await page.waitForTimeout(300);

      // Check for "You" badge
      await expect(page.locator('text=You')).toBeVisible();
    });

    test('should show Invite User button for admins', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      //  to await page.click('button[role="tab"]:has-text("Team Management")');
      await page.waitForTimeout(300);

      // Check for Invite button
      await expect(page.locator('button:has-text("Invite User")')).toBeVisible();
    });

    test('should NOT show Invite User button for regular users', async ({ page }) => {
      // Login as regular user
      await login(page, { email: regularUserEmail, password: 'user123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      //  to await page.click('button[role="tab"]:has-text("Team Management")');
      await page.waitForTimeout(300);

      // Invite button should not exist
      await expect(page.locator('button:has-text("Invite User")')).not.toBeVisible();
    });
  });

  test.describe('await page.click('button[role="tab"]:has-text("Team Management")');
      await page.waitForTimeout(300);

      // Click Invite User
      await page.click('button:has-text("Invite User")');

      // Check dialog opened
      await expect(page.locator('text=Invite Team Member')).toBeVisible();
      await expect(page.locator('input[id="invite-email"]')).toBeVisible();
      await expect(page.locator('input[id="invite-name"]')).toBeVisible();
    });

    test('should successfully invite a new user', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      //  to await page.click('button[role="tab"]:has-text("Team Management")');
      await page.waitForTimeout(300);

      // Click Invite User
      await page.click('button:has-text("Invite User")');

      // Fill in invite form
      const newUserEmail = `invited-user-${Date.now()}@test.com`;
      await page.fill('input[id="invite-email"]', newUserEmail);
      await page.fill('input[id="invite-name"]', 'Invited Test User');

      // Send invitation
      await page.click('button:has-text("Send Invitation")');

      // Wait for success
      await expect(page.locator('text=User invited successfully')).toBeVisible();

      // Verify new user appears in table
      await expect(page.locator(`text=${newUserEmail}`)).toBeVisible();

      // Clean up
      await prisma.user.delete({
        where: { email: newUserEmail },
      });
    });

    test('should invite user as admin role', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      //  to await page.click('button[role="tab"]:has-text("Team Management")');
      await page.waitForTimeout(300);

      // Click Invite User
      await page.click('button:has-text("Invite User")');

      // Fill in invite form
      const newAdminEmail = `invited-admin-${Date.now()}@test.com`;
      await page.fill('input[id="invite-email"]', newAdminEmail);
      await page.fill('input[id="invite-name"]', 'Invited Admin User');

      // Select Admin role
      await page.click('button[id="invite-role"]');
      await page.click('text=Administrator');

      // Send invitation
      await page.click('button:has-text("Send Invitation")');

      // Wait for success
      await expect(page.locator('text=User invited successfully')).toBeVisible();

      // Verify user has admin badge
      const userRow = page.locator(`tr:has-text("${newAdminEmail}")`);
      await expect(userRow.locator('text=Admin')).toBeVisible();

      // Clean up
      await prisma.user.delete({
        where: { email: newAdminEmail },
      });
    });

    test('should show error when inviting duplicate email', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      //  to await page.click('button[role="tab"]:has-text("Team Management")');
      await page.waitForTimeout(300);

      // Click Invite User
      await page.click('button:has-text("Invite User")');

      // Try to invite existing user
      await page.fill('input[id="invite-email"]', adminEmail);
      await page.fill('input[id="invite-name"]', 'Duplicate User');

      // Send invitation
      await page.click('button:has-text("Send Invitation")');

      // Should show error
      await expect(page.locator('text=A user with this email already exists')).toBeVisible();
    });
  });

  test.describe('await page.click('button[role="tab"]:has-text("Team Management")');
      await page.waitForTimeout(300);

      // Find regular user's row and role dropdown
      const userRow = page.locator(`tr:has-text("${regularUserEmail}")`);
      const roleSelect = userRow.locator('button[role="combobox"]');

      // Click role dropdown
      await roleSelect.click();

      // Select Admin
      await page.click('text=Admin');

      // Wait for success
      await expect(page.locator('text=User role updated')).toBeVisible();

      // Verify role changed
      await expect(userRow.locator('text=Admin')).toBeVisible();

      // Change back to USER for other tests
      await roleSelect.click();
      await page.click('text=User').last();
    });

    test('should not allow changing own role', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      //  to await page.click('button[role="tab"]:has-text("Team Management")');
      await page.waitForTimeout(300);

      // Find own user row - should not have editable dropdown
      const ownUserRow = page.locator(`tr:has-text("${adminEmail}")`);

      // Should show role as badge, not dropdown
      await expect(ownUserRow.locator('button[role="combobox"]')).not.toBeVisible();
      await expect(ownUserRow.locator('text=Administrator')).toBeVisible();
    });
  });

  test.describe('await page.click('button[role="tab"]:has-text("Team Management")');
      await page.waitForTimeout(300);

      // Verify user exists
      await expect(page.locator(`text=${tempUserEmail}`)).toBeVisible();

      // Set up dialog handler
      page.on('dialog', dialog => dialog.accept());

      // Find and click remove button
      const userRow = page.locator(`tr:has-text("${tempUserEmail}")`);
      await userRow.locator('button').filter({ hasText: '' }).click();

      // Wait for success
      await expect(page.locator('text=User removed from organization')).toBeVisible();

      // Verify user is gone
      await expect(page.locator(`text=${tempUserEmail}`)).not.toBeVisible();
    });

    test('should not show remove button for current user', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      //  to await page.click('button[role="tab"]:has-text("Team Management")');
      await page.waitForTimeout(300);

      // Find own user row
      const ownUserRow = page.locator(`tr:has-text("${adminEmail}")`);

      // Should not have remove button in actions column
      const actionsCell = ownUserRow.locator('td').last();
      await expect(actionsCell.locator('button')).not.toBeVisible();
    });
  });

  test.describe('await page.click('button[role="tab"]:has-text("My Account")');
      await page.waitForTimeout(300);

      // Verify personal info displayed
      await expect(page.locator('text=Personal Information')).toBeVisible();
      await expect(page.locator(`text=${adminEmail}`)).toBeVisible();
      await expect(page.locator('text=Settings Admin')).toBeVisible();
      await expect(page.locator('text=Administrator')).toBeVisible();
    });

    test('should display account type correctly for regular user', async ({ page }) => {
      // Login as regular user
      await login(page, { email: regularUserEmail, password: 'user123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      //  to await page.click('button[role="tab"]:has-text("My Account")');
      await page.waitForTimeout(300);

      // Verify shows Standard User
      await expect(page.locator('text=Standard User')).toBeVisible();
      await expect(page.locator(`text=${regularUserEmail}`)).toBeVisible();
    });

    test('should display password & security section', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      // Switch to My Account tab
      await page.click('button[role="tab"]:has-text("My Account")');
      await page.waitForTimeout(300);

      // Verify password section exists (but disabled)
      await expect(page.locator('text=Password & Security')).toBeVisible();
      await expect(page.locator('button:has-text("Change Password (Coming Soon)")')).toBeDisabled();
    });

    test('should display preferences section', async ({ page }) => {
      // Login as admin
      await login(page, { email: adminEmail, password: 'admin123' });
      await page.goto('/dashboard/settings');
      await page.waitForLoadState('networkidle');

      // Switch to My Account tab
      await page.click('button[role="tab"]:has-text("My Account")');
      await page.waitForTimeout(300);

      // Verify preferences section
      await expect(page.locator('text=Preferences')).toBeVisible();
      await expect(page.locator('text=Email Notifications')).toBeVisible();
      await expect(page.locator('text=Language & Region')).toBeVisible();
    });
  });

  test.describe('Authorization Checks', () => {
    test('regular user cannot access edit profile API', async ({ request }) => {
      // Login as regular user to get session
      const loginResponse = await request.post('/api/auth/callback/credentials', {
        data: {
          email: regularUserEmail,
          password: 'user123',
        },
      });

      // Try to update organization
      const updateResponse = await request.put('/api/organization/profile', {
        data: {
          name: 'Unauthorized Update',
        },
      });

      // Should fail with unauthorized
      expect(updateResponse.status()).toBe(401);
    });

    test('regular user cannot invite users', async ({ request }) => {
      // Login as regular user
      const loginResponse = await request.post('/api/auth/callback/credentials', {
        data: {
          email: regularUserEmail,
          password: 'user123',
        },
      });

      // Try to invite user
      const inviteResponse = await request.post('/api/organization/users', {
        data: {
          email: 'unauthorized@test.com',
          name: 'Unauthorized User',
          role: 'USER',
        },
      });

      // Should fail
      expect(inviteResponse.status()).toBe(401);
    });

    test('regular user cannot update user roles', async ({ request }) => {
      // Login as regular user
      const loginResponse = await request.post('/api/auth/callback/credentials', {
        data: {
          email: regularUserEmail,
          password: 'user123',
        },
      });

      // Try to update role
      const updateResponse = await request.put(`/api/organization/users/${adminUserId}`, {
        data: {
          role: 'USER',
        },
      });

      // Should fail
      expect(updateResponse.status()).toBe(401);
    });

    test('regular user cannot remove users', async ({ request }) => {
      // Login as regular user
      const loginResponse = await request.post('/api/auth/callback/credentials', {
        data: {
          email: regularUserEmail,
          password: 'user123',
        },
      });

      // Try to remove admin
      const deleteResponse = await request.delete(`/api/organization/users/${adminUserId}`);

      // Should fail
      expect(deleteResponse.status()).toBe(401);
    });
  });
});
